# Fibonacci

Программа Fibonacci осуществляет вычисление чисел ряда Фибоначчи. Программа принимает 2 целых числа x, y и возвращает
числа ряда Фибоначчи с порядковыми номерами [x;y]. Для кэширования вычисленных значений используется NoSQL СУБД Redis
(v.6.2.6). Работа сервиса осуществляется через REST и gRPC API.

## Установка

Для компиляции бинарного файла, запуска программы с дефолтными конфигурациями и тестов воспользуйтесь Makefile.

## Конфигурация и запуск программы

При запуске Fibonacci принимает следующие флаги:

* `version` - отображение версии программы
* `config` - путь к файлу с конфигурациями. Дефолтное значение - `./configs/fibonacci_config.json`
* `redis` - использование Redis для кэширования. Дефолтное значение - `true`. Поведение, аналогичное поведению с флагом
  `--redis=false`, можно получить установив параметр `MaxErrors = 0` в файле конфигураций

Пример запуска программы:

```bash
$ fibonacci --config=./configs/my_config.json --redis=false
```

Fibonacci считывает конфигурации из файла форматов JSON, Yaml, Toml. Пример файла конфигурации в формате JSON
представлен в директории `configs`

#### Конфигурации HTTP сервера

* `Host` - хост сервера
* `Port` - порт сервера
* `Timeout` - таймаут вычисления чисел ряда Фибоначчи

#### Конфигурации gRPC сервера

* `Host` - хост сервера
* `Port` - порт сервера
* `Timeout` - таймаут вычисления чисел ряда Фибоначчи

#### Конфигурации Redis

* `host` - хост сервера Redis
* `port` - порт сервера Redis
* `Expiration` - время хранения кэшированных данных в Redis
* `MaxErrors` - максимальное количество ошибок получения/добавления данных в Redis, после которого сервис перестает
  обращаться к кэшу Redis и выполняет вычисления внутри программы.

## Docker

Для сборки и запуска программы в Docker-контейнере воспользуйтесь Makefile (`docker-build`, `docker-up`)
. При использовании Docker для корректной работы Redis в файле конфигурации необходимо установить следующий параметр:

```bash
  "Redis": {
    "Host": "redis"
    ...
    }
```

Также при изменении адресов Redis сервера, HTTP и gRPC серверов в файле конфигурации необходимо внести соответствующие
изменения в файл `docker-compose.yaml`:

```bash
app:
    ...
    ports:
      - "8080:8080"   // изменить на актуальные
      - "50052:50052" // изменить на актуальные
    ...  
redis:
    ...
    ports:
      - "6379:6379"   // изменить на актуальные
```

## Пакеты

Программа состоит из следующих пакетов:

* `config` - работа с файлами конфигураций
* `rds` - работа с Redis
* `server` - взаимодействие клиента через REST (подпакет `httpserver`) и gRPC (подпакет `grpcserver`) API
* `service` - выполнение основной логики программы по вычислению чисел ряда Фибоначчи

## REST API

HTTP сервер прослушивает адрес, передаваемый через конфигурации, и имеет один эндпоинт - `/`. В теле GET-запроса HTTP
сервер ожидает два целых числа через запятую (порядок чисел не имеет значения). В качестве ответа сервер отправляет
структуру `Responce` в формате JSON:

```bash
Response {
  Data []string // вычисленные значения
  Err  string   // текст ошибки при ее возникновении
}
```

## gRPC API

gRPC сервер реализует метод `GetFibonacci`, который принимает в качестве аргументов 2 числа и возвращает структуру:

```bash
message response {
  repeated string data = 1; // вычисленные значения
  string err = 2;           // текст ошибки при ее возникновении
}
```

Proto-файл расположен в директории `proto`. Для генерации gRPC-кода для Go можно выполнить `make generate`
